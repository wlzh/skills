# 发票识别 Skill

自动识别所有类型的发票（交通、住宿、餐饮等），提取关键信息并生成分类统计报告。

## 功能特性

- 🔍 **全面识别** - 识别市内交通、长途交通、住宿、餐饮等所有类型发票
- 📂 **智能分类** - 自动按四大类别分类统计
- 🧮 **金额验证** - 自动验证总额与各分类小计，防止计算错误
- ✅ **字段确认** - 每张发票提取后二次确认发票号和金额，确保准确性
- ✈️ **长途交通合并** - 飞机票+火车票自动合并计算长途交通费用总和
- 📦 **支持 ZIP** - 可以直接处理压缩包，自动解压并清理
- 🗑️ **智能清理** - 自动删除 XML/OFD 元数据文件和原始 ZIP 文件
- 📁 **文件扁平化** - ZIP 解压后文件自动移动到报告目录根层级
- 🔖 **发票号汇总** - 自动生成所有发票号的汇总行，方便复制粘贴
- 📊 **表格输出** - 清晰的Markdown表格格式，易读易用
- 🎯 **精准提取** - 提取日期、金额、行程等关键信息
- 💰 **自动统计** - 计算总金额和分类汇总
- 🔄 **去重处理** - 自动识别重复发票（如行程单+电子发票）

## 使用方法

### 基本用法

```bash
# 扫描指定目录
/invoice-scanner ./发票文件夹

# 扫描 ZIP 文件
/invoice-scanner ./receipts.zip

# 扫描当前目录
/invoice-scanner .

# 扫描包含 ZIP 文件的目录（自动解压）
# 如果目录中有 ZIP 文件，会自动解压并识别所有发票
/invoice-scanner ./mixed-invoices
```

### 自动解压与文件清理

当扫描目录时，skill 会自动：
1. **清理无用文件** - 删除所有 `.xml` 和 `.ofd` 元数据文件
2. **检测 ZIP 文件** - 找到目录中的所有 `.zip` 压缩包
3. **解压并扁平化** - 将 ZIP 中的所有文件提取到报告目录（不保留文件夹结构）
4. **自动清理** - 删除原始 ZIP 文件和临时解压目录
5. **统一扫描** - 扫描所有发票文件（包括原有文件和解压出的文件）
6. **生成报告** - 在干净整洁的目录中生成识别报告

处理示例：
```
发票文件夹/
├── 交通费.zip          ← 自动解压后删除
│   ├── 打车1.jpg       → 移动到 发票文件夹/打车1.jpg
│   └── 地铁票.png      → 移动到 发票文件夹/地铁票.png
├── 酒店发票.pdf        ← 直接识别
├── 餐饮.xml            ← 自动删除（元数据文件）
└── 发票.ofd            ← 自动删除（元数据文件）

处理后：
发票文件夹/
├── 打车1.jpg          ← 从 ZIP 解压出来的
├── 地铁票.png         ← 从 ZIP 解压出来的
├── 酒店发票.pdf       ← 原有文件
└── invoices.md        ← 生成的报告
```

## 支持的发票类型

### 📍 市内交通
- 打车发票（滴滴、出租车、网约车等）
- 地铁票、公交票

### ✈️ 长途交通
- 飞机票（机票行程单、电子客票行程单）
- 火车票（高铁、动车、普通列车）
- 长途汽车票

### 🏨 住宿
- 酒店住宿发票
- 酒店结账单
- 增值税专用发票（住宿服务）

### 📦 其他
- 餐饮发票
- 通讯费发票
- 办公用品、快递等其他消费

### 支持的文件格式

- 图片：`.jpg`, `.jpeg`, `.png`
- 文档：`.pdf`
- 压缩包：`.zip`

## 输出结果

执行后会在目标目录生成报告文件：

### `invoices.md` - 发票报销单

包含以下内容：

#### 1. 📋 发票号汇总（顶部）
所有发票号用斜杠分隔连接成一行，方便复制粘贴：
```
发票号汇总: 25339190041007564272/25419165773006797356/25419239047000008834/...
```

#### 2. 📊 统计摘要
- 总金额和发票总数
- 按类型分类统计（交通费、住宿费、餐饮费等）
- 每个分类的数量和金额小计

#### 3. 📋 发票明细表
清晰的表格形式展示每张发票：

| 序号 | 发票号码 | 类型 | 金额(¥) | 开票日期 | 说明 |
|------|----------|------|---------|----------|------|
| 1 | 25339190... | 交通费-火车票 | 490.50 | 2025-11-30 | 杭州东→郑州东 G3118 |
| 2 | 25419165... | 交通费-打车 | 76.38 | 2025-11-30 | 滴滴出行 |
| 3 | 25412000... | 住宿费 | 2,895.04 | 2025-11-29 | 汉庭酒店 12天 |

#### 4. ❗ 特殊说明
- 未识别文件列表（如支付截图、非正式发票）
- 已解压的ZIP文件清单
- 重复发票处理说明

## 应用场景

- 💼 **差旅报销** - 自动整理出差所有费用（交通、住宿、餐饮）
- 📝 **财务统计** - 快速汇总各类费用，按类别分析
- 🗂️ **发票归档** - 结构化存储所有发票信息
- 🔖 **发票号管理** - 一键复制所有发票号，方便录入系统
- 🏢 **企业报销** - 提供完整的报销单据清单和明细表格

## 技术原理

使用 Claude 的多模态能力直接识别图片中的文字和结构：
1. 读取图片/PDF 文件
2. AI 视觉分析判断发票类型和分类
3. 提取关键字段信息
4. 智能去重（识别重复发票）
5. 生成结构化报告

## 注意事项

- 确保发票图片清晰可读
- 支持中文发票（国内航班、火车、打车平台、酒店、餐饮等）
- 自动识别并避免重复发票（如行程单+对应电子发票）
- 对于无法识别的图片会在报告中标注原因
- **字段提取确认**：
  - 每张发票提取后会二次确认发票号和金额
  - 无法确认的字段会标记 "⚠️ 待人工复核"
  - 提取存疑的发票会在报告中单独列出
- **ZIP 文件处理**：
  - 解压后文件会移动到报告目录根层级（扁平化处理）
  - 原始 ZIP 文件会被自动删除
  - 临时解压目录会被自动清理
- **文件自动清理**：
  - 自动删除 `.xml` 和 `.ofd` 元数据文件
  - 这些文件是电子发票的附属文件，识别后不再需要
- 非正式发票（如支付截图、转账记录）会单独列出，不计入统计

## 示例输出

### 控制台输出

```
🗑️ 已清理 3 个无用文件（.xml, .ofd）
📦 已解压并清理 2 个 ZIP 文件

✅ 发票扫描完成

📊 统计摘要：
- 总计: 12 张发票
- 总金额: ¥4,072.27
- ✓ 金额已校验

按分类统计：
✈️ 长途交通合计: 5 张 (¥2,398.50)  ← 飞机+火车总和
  - 火车票: 4 张 (¥1,729.50)
  - 机票: 1 张 (¥669.00)

🚕 市内交通: 2 张 (¥150.15)
  - 打车: 2 张 (¥150.15)

🏨 住宿费: 4 张 (¥1,469.44)

🔄 退票费: 2 张 (¥104.50)

💡 金额验证：
  长途交通 (¥2,398.50) + 市内交通 (¥150.15) + 住宿 (¥1,469.44) + 退票费 (¥104.50) = 总计 (¥4,072.27) ✓

⚠️ 1 张发票需要人工复核（发票字段提取存疑）

📄 报告已生成：
- /Users/m/Downloads/tmp/baoxiao/重庆-郑州-三门峡/invoices.md

🗑️ 已清理 5 个中间文件（.xml, .ofd, .zip）

📦 已打包最终文件：/Users/m/Downloads/tmp/baoxiao/重庆-郑州-三门峡/重庆-郑州-三门峡.zip
   压缩包大小：12.45 MB
   位置：报告目录内部
```

### 生成的报告文件示例

```markdown
# 发票报销单

**报销期间**: 重庆-郑州-三门峡

**发票号汇总**: 25509130077001116677/25419265773000438991/25419265773000438992/...

---

## 统计摘要

- **总金额**: ¥4,072.27
- **发票总数**: 12张
- **✓ 金额已校验**

### 分类统计
- **长途交通合计**: ¥2,398.50 (5张) ← 飞机+火车总和
  - 火车票: ¥1,729.50 (4张)
  - 机票: ¥669.00 (1张)
- **市内交通**: ¥150.15 (2张)
  - 打车: ¥150.15 (2张)
- **住宿费**: ¥1,469.44 (4张)
- **退票费**: ¥104.50 (2张)

### 💡 金额验证
长途交通 (¥2,398.50) + 市内交通 (¥150.15) + 住宿 (¥1,469.44) + 退票费 (¥104.50) = 总计 (¥4,072.27) ✓

---

## 发票明细

| 序号 | 发票号码 | 类型 | 金额(¥) | 开票日期 | 说明 |
|------|----------|------|---------|----------|------|
| 1 | 25509130077001116677 | 交通费-火车票 | 540.00 | 2025-11-16 | 重庆西→三门峡南 G1834 |
| 2 | 25419265773000438991 | 退票费 | 8.50 | 2025-11-16 | 郑州东→杭州东 G3138 差额退票 |
| ... | ... | ... | ... | ... | ... |

---

## ⚠️ 需要人工复核的发票

| 序号 | 文件名 | 问题描述 |
|------|--------|----------|
| 1 | 发票_003.jpg | ⚠️ 发票号码提取存疑，请人工复核 |

---

**制表日期**: 2026-01-13
```

## 版本信息

- 版本: 2.5.0
- 支持的发票类型:
  - 市内交通（打车、地铁、公交）
  - 长途交通（飞机票、火车票、长途汽车）
  - 住宿（酒店发票、结账单）
  - 其他（餐饮、通讯、办公用品等）
- 输出格式: Markdown 表格
- 主要功能:
  - ✨ 发票号汇总行（用斜杠分隔，方便复制）
  - 🔄 智能分类、去重处理、全类型识别
  - 🧮 **金额自动验证** - 防止计算错误
  - ✈️ **长途交通合并计算** - 飞机+火车+长途汽车合并统计
  - ✅ **字段提取确认** - 二次确认发票号和金额
  - 🗑️ **智能文件清理** - 自动删除XML/OFD/ZIP文件
  - 📁 **文件扁平化处理** - ZIP解压后文件自动整理
  - 📦 **最终打包** - 处理完成后自动打包成ZIP文件（v2.5.0新增）

### v2.5.0 更新内容 (2026-01-13)
- ✅ 新增最终打包功能 - 完成所有处理后自动将报告目录打包成ZIP文件
- ✅ 压缩包自动以文件夹名称命名（如：发票2024.zip）
- ✅ 排除系统文件和自身，生成干净的压缩包
- ✅ 压缩包保存在报告目录内部，方便一键下载和分享

### v2.4.0 更新内容 (2026-01-13)
- ✅ 新增发票字段提取二次确认机制（发票号、金额）
- ✅ 自动删除 XML 和 OFD 元数据文件
- ✅ ZIP 解压后自动扁平化文件结构
- ✅ 处理完成后自动删除原始 ZIP 文件
- ✅ 在报告中添加"需要人工复核的发票"章节
- ✅ 提取存疑的字段会标记 ⚠️ 并提示复核

### v2.3.0 更新内容 (2026-01-13)
- ✅ 新增金额自动验证功能，确保总额 = 各分类小计之和
- ✅ 长途交通费用合并计算（飞机票+火车票+长途汽车票）
- ✅ 在控制台和报告中显示金额验证公式和结果
- ✅ 添加金额提取精度控制（保留2位小数）
- ✅ 优化输出格式，更清晰地展示长途交通合计和明细
